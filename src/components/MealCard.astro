---
import type { ContentSection } from '../utils/weekParser';
import { groupSubsections } from '../utils/weekParser';
import { getInstructionBadgeColor, getInstructionColor, sectionColors } from '../config/colors';
import { marked } from 'marked';

interface Props {
  section: ContentSection;
}

const { section } = Astro.props;

const mealIndex = Math.max(0, Number(section.id.split('-')[1] ?? '1') - 1);
const quickReadCodenameScheme = getInstructionBadgeColor(mealIndex);
const quickReadInfoScheme = sectionColors.firstSubsection;

// Group blocks for rendering
const groups = groupSubsections(section.subsections);

// Track instruction group index for color cycling
let instructionGroupIndex = 0;

function renderMarkdown(text: string | undefined): string {
  return marked.parseInline(text?.trim() ?? '');
}
---

<div 
  id={`print-section-${section.id}`} 
  class={`print-section meal ${section.cooked ? 'meal-cooked' : ''}`}
  data-section-type="meal" 
  data-cooked={section.cooked ? 'true' : 'false'}
>
  <div class="meal-header">
    <h2>{section.title}</h2>
  </div>

  {section.quickRead?.codename && (
    <div class="meal-quick-read flex flex-wrap items-center gap-sm mb-lg text-[0.95rem] mobile:gap-xs">
      <span
        class="quick-read-codename px-sm py-xs rounded font-bold border"
        style={`background: ${quickReadCodenameScheme.bg}; color: ${quickReadCodenameScheme.heading}; border-color: ${quickReadCodenameScheme.border}`}
      >
        {section.quickRead.codename}
      </span>
      {section.quickRead.details && (
        <span
          class="quick-read-details px-sm py-xs rounded font-medium border"
          style={`background: ${quickReadInfoScheme.bg}; color: ${quickReadInfoScheme.heading}; border-color: ${quickReadInfoScheme.border}`}
        >
          {section.quickRead.details}
        </span>
      )}
    </div>
  )}
  
  {/* Render block groups */}
  {groups.map((group, groupIndex) => {
    // Determine group type based on first block's depth
    const isFieldsGroup = group[0].depth === 4; // H4 = fields
    const isSectionGroup = group[0].depth === 3; // H3 = instruction section

    // Color logic: fields groups use firstSubsection colors, instruction sections cycle through instruction colors
    const colors = isFieldsGroup
      ? sectionColors.firstSubsection
      : getInstructionColor(instructionGroupIndex++);

    return (
      <div
        class={`subsection-group mb-lg p-md rounded-md border-0 border-solid border-l-4 last:mb-0 ${isFieldsGroup ? 'info-group flex flex-col gap-md' : 'instruction-group mt-lg'}`}
        style={`background: ${colors.bg}; border-left-color: ${colors.border};`}
      >
        {group.map((sub) => (
          <div class="subsection">
            {isFieldsGroup ? (
              // H4 fields: render as labeled field rows
              <div class="subsection-field leading-relaxed text-[1.1rem] mobile:text-[1.25rem] mobile:leading-extra-loose">
                <strong class="text-primary inline-block min-w-[120px]">{sub.title}</strong>
                {sub.content && (
                  <span
                    class="subsection-field-body inline text-base"
                    set:html={renderMarkdown(sub.content)}
                  />
                )}
              </div>
            ) : (
              // H3 sections: render as distinct instruction blocks
              <>
                <h3 class="mt-0 mb-md text-[1.25rem] font-semibold mobile:text-[1.3rem] mobile:mb-md" style={`color: ${colors.heading};`}>{sub.title}</h3>
                {sub.items && sub.items.length > 0 && (
                  <ul class="list-disc ml-lg">
                    {sub.items.map((item: string) => (
                      <li class="mb-sm leading-relaxed text-[1.1rem] mobile:text-[1.25rem] mobile:leading-extra-loose" set:html={renderMarkdown(item)} />
                    ))}
                  </ul>
                )}
                {sub.content && (
                  <div class="subsection-content">
                    {sub.content.split('\n\n').map((paragraph: string) => (
                      <p class="mb-md leading-relaxed text-[1.1rem] last:mb-0 mobile:text-[1.25rem] mobile:leading-extra-loose" set:html={renderMarkdown(paragraph)} />
                    ))}
                  </div>
                )}
              </>
            )}
          </div>
        ))}
      </div>
    );
  })}
  
  {/* Empty state */}
  {groups.length === 0 && (
    <div class="empty-state">
      <p>No content available for this section.</p>
    </div>
  )}
</div>

<style>
  /* Meal card wrapper - main container styling */
  .meal {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
    width: 100%;
    break-inside: avoid;
  }

  /* Meal header layout */
  .meal-header {
    display: flex;
    justify-content: flex-start;
    align-items: flex-start;
    margin-bottom: var(--spacing-lg);
    gap: var(--spacing-md);
  }

  .meal-header h2 {
    margin: 0;
    flex: 1;
  }


  /* Cooked meal state overrides - semantic state styling */
  .meal-cooked {
    background: var(--color-cooked-bg, #f0ede6) !important;
    border-color: var(--color-cooked-border, #d8d4c9) !important;
  }

  .meal-cooked h2 {
    color: var(--color-cooked-text, #8a887f);
  }

  .meal-cooked .subsection-group {
    background: var(--color-cooked-bg, #f0ede6) !important;
    border-left-color: var(--color-cooked-border, #d8d4c9) !important;
  }

  .meal-cooked strong {
    color: var(--color-cooked-text, #8a887f) !important;
  }

  .meal-cooked h3 {
    color: var(--color-cooked-text, #8a887f) !important;
  }

  .meal-cooked li,
  .meal-cooked p {
    color: var(--color-cooked-text, #8a887f);
  }

  .meal-cooked :global(a) {
    color: var(--color-cooked-text);
    text-decoration-color: var(--color-cooked-text);
  }

  /* Markdown link styling */
  .subsection-content :global(a),
  .instruction-group :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
    text-decoration-color: var(--color-accent);
    text-underline-offset: 2px;
    transition: color 0.2s ease;
  }

  .subsection-content :global(a):hover,
  .instruction-group :global(a):hover {
    color: var(--color-accent);
  }

  /* Mobile responsive adjustments */
  @media screen(mobile) {
    .meal-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--spacing-md);
    }

    .meal-header h2 {
      font-size: 2rem;
    }

    .subsection-field strong {
      display: block;
      margin-bottom: var(--spacing-xs);
    }
  }
</style>
