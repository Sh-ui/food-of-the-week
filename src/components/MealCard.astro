---
import type { ContentSection } from '../utils/weekParser';
import { groupSubsections } from '../utils/weekParser';
import { sectionColors, getInstructionColor } from '../config/colors';

interface Props {
  section: ContentSection;
}

const { section } = Astro.props;

// Group subsections for rendering
const groups = groupSubsections(section.subsections);

// Helper function to render markdown links to HTML
function renderMarkdown(text: string): string {
  // Convert markdown links [text](url) to HTML links
  return text.trim().replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
}
---

<div 
  id={`print-section-${section.id}`} 
  class={`print-section section meal ${section.cooked ? 'meal-cooked' : ''}`} 
  data-section-type="meal" 
  data-cooked={section.cooked ? 'true' : 'false'}
>
  <div class="meal-header">
    <span 
      class={`cooked-indicator ${section.cooked ? 'is-cooked' : ''}`} 
      aria-label={section.cooked ? 'Meal has been cooked' : 'Meal not yet cooked'}
    >
      {section.cooked ? 'âœ“' : ''}
    </span>
    <h2>{section.title}</h2>
  </div>
  
  {/* Render subsection groups */}
  {groups.map((group, groupIndex) => {
    // First group uses firstSubsection colors (meal info)
    // Subsequent groups use cycling instruction colors
    const isFirstGroup = groupIndex === 0;
    const colors = isFirstGroup 
      ? sectionColors.firstSubsection 
      : getInstructionColor(groupIndex - 1);
    
    return (
      <div 
        class={`subsection-group ${isFirstGroup ? 'info-group' : 'instruction-group'}`}
        style={`--group-bg: ${colors.bg}; --group-border: ${colors.border}; --group-heading: ${colors.heading};`}
      >
        {group.map((sub) => (
          <div class="subsection">
            {/* For grouped items, show as labeled fields */}
            {isFirstGroup ? (
              <div class="subsection-field">
                <strong>{sub.title}:</strong> {sub.content}
              </div>
            ) : (
              <>
                <h3>{sub.title}</h3>
                {sub.items && sub.items.length > 0 && (
                  <ul>
                    {sub.items.map((item: string) => (
                      <li set:html={renderMarkdown(item)} />
                    ))}
                  </ul>
                )}
                {sub.content && (
                  <div class="subsection-content">
                    {sub.content.split('\n\n').map((paragraph: string) => (
                      <p set:html={renderMarkdown(paragraph)} />
                    ))}
                  </div>
                )}
              </>
            )}
          </div>
        ))}
      </div>
    );
  })}
  
  {/* Empty state */}
  {groups.length === 0 && (
    <div class="empty-state">
      <p>No content available for this section.</p>
    </div>
  )}
</div>

<style>
  .meal {
    break-inside: avoid;
  }

  .meal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--spacing-lg);
    gap: var(--spacing-md);
  }

  .meal-header h2 {
    margin: 0;
    flex: 1;
  }

  /* Cooked indicator - circular button next to heading */
  .cooked-indicator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.75rem;
    height: 1.75rem;
    border: 2px solid var(--color-text-light, #6b6a62);
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 0.25rem;
    font-size: 0.9rem;
    color: transparent;
    cursor: default;
    user-select: none;
  }

  .cooked-indicator.is-cooked {
    background: var(--color-cooked-text, #8a887f);
    border-color: var(--color-cooked-text, #8a887f);
    color: white;
  }

  /* Greyed-out styling for cooked meals */
  .meal-cooked {
    background: var(--color-cooked-bg, #f0ede6);
    border-color: var(--color-cooked-border, #d8d4c9);
  }

  .meal-cooked .meal-header h2 {
    color: var(--color-cooked-text, #8a887f);
  }

  .meal-cooked .subsection-group {
    background: var(--color-cooked-bg, #f0ede6) !important;
    border-left-color: var(--color-cooked-border, #d8d4c9) !important;
  }

  .meal-cooked .subsection-field {
    color: var(--color-cooked-text, #8a887f);
  }

  .meal-cooked .subsection-field strong {
    color: var(--color-cooked-text, #8a887f);
  }

  .meal-cooked .subsection h3 {
    color: var(--color-cooked-text, #8a887f) !important;
  }

  .meal-cooked .subsection li,
  .meal-cooked .subsection-content p {
    color: var(--color-cooked-text, #8a887f);
  }

  .meal-cooked .subsection-content :global(a),
  .meal-cooked .subsection :global(a) {
    color: var(--color-cooked-text);
    text-decoration-color: var(--color-cooked-text);
  }

  /* Subsection groups - styled via CSS custom properties */
  .subsection-group {
    margin-bottom: var(--spacing-lg);
    padding: var(--spacing-md);
    border-radius: 6px;
    border-left: 4px solid var(--group-border);
    background: var(--group-bg);
  }

  .subsection-group:last-child {
    margin-bottom: 0;
  }

  /* Info group (first group - meal details) */
  .info-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .subsection-field {
    line-height: 1.68;
    font-size: 1.1rem;
  }

  .subsection-field strong {
    color: var(--color-primary);
    display: inline-block;
    min-width: 120px;
  }

  /* Instruction groups */
  .instruction-group {
    margin-top: var(--spacing-lg);
  }

  .instruction-group h3 {
    margin-top: 0;
    margin-bottom: var(--spacing-md);
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--group-heading);
  }

  .instruction-group ul {
    list-style: disc;
    margin-left: var(--spacing-lg);
  }

  .instruction-group li {
    margin-bottom: var(--spacing-sm);
    line-height: 1.68;
    font-size: 1.1rem;
  }

  .subsection-content p {
    margin-bottom: var(--spacing-md);
    line-height: 1.68;
    font-size: 1.1rem;
  }

  .subsection-content p:last-child {
    margin-bottom: 0;
  }

  /* Style markdown links */
  .subsection-content :global(a),
  .instruction-group :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
    text-decoration-color: var(--color-accent);
    text-underline-offset: 2px;
    transition: color 0.2s ease;
  }

  .subsection-content :global(a):hover,
  .instruction-group :global(a):hover {
    color: var(--color-accent);
  }

  .empty-state {
    color: var(--color-text-light);
    font-style: italic;
  }

  @media screen(mobile) {
    .meal-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--spacing-md);
    }

    .cooked-indicator {
      width: 2rem;
      height: 2rem;
      font-size: 1rem;
    }
    
    .meal-header h2 {
      font-size: 2rem;
    }

    .subsection-field {
      font-size: 1.25rem;
      line-height: 1.75;
    }

    .subsection-field strong {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-size: 1.25rem;
    }
    
    .subsection-group {
      padding: var(--spacing-lg);
    }
    
    .instruction-group h3 {
      font-size: 1.3rem;
      margin-bottom: var(--spacing-md);
    }
    
    .instruction-group li,
    .subsection-content p {
      font-size: 1.25rem;
      line-height: 1.75;
    }
  }
</style>
