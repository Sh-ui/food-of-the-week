---
import type { GroceryCategory } from '../utils/readmeParser';

interface Props {
  categories: GroceryCategory[];
  weekTitle: string;
}

const { categories } = Astro.props;
---

<div id="print-section-grocery-list" class="print-section section" data-section-type="grocery">
  <div class="section-header">
    <h2>Grocery List</h2>
    <button class="button button-secondary print-button" data-print-target="grocery-list">
      Print Grocery List
    </button>
  </div>
  
  <div class="grocery-categories">
    {categories.map((category) => (
      <div class="grocery-category">
        <h3>{category.name}</h3>
        <ul class="grocery-items">
          {category.items.map((item, index) => (
            <li class={`grocery-item ${item.globallyChecked ? 'globally-checked' : ''}`}>
              <label>
                <input
                  type="checkbox"
                  class={`grocery-checkbox ${item.globallyChecked ? 'global-checkbox' : 'local-checkbox'}`}
                  data-category={category.name}
                  data-index={index}
                  data-item={item.text}
                  data-globally-checked={item.globallyChecked ? 'true' : 'false'}
                  checked={item.globallyChecked}
                  disabled={item.globallyChecked}
                />
                <span class="item-text">{item.text}</span>
              </label>
            </li>
          ))}
        </ul>
      </div>
    ))}
  </div>
</div>

<script>
  // Store checked items in localStorage with week-specific key
  function getStorageKey(): string {
    // Get week title from page to create unique key
    const weekElement = document.querySelector('h1');
    const weekTitle = weekElement?.textContent || 'current-week';
    return `grocery-list-${weekTitle.toLowerCase().replace(/\s+/g, '-')}`;
  }

  function loadCheckedItems(): Set<string> {
    const key = getStorageKey();
    const stored = localStorage.getItem(key);
    return stored ? new Set(JSON.parse(stored)) : new Set();
  }

  function saveCheckedItems(checked: Set<string>): void {
    const key = getStorageKey();
    localStorage.setItem(key, JSON.stringify([...checked]));
  }

  function getItemKey(checkbox: HTMLInputElement): string {
    const category = checkbox.dataset.category || '';
    const index = checkbox.dataset.index || '';
    const item = checkbox.dataset.item || '';
    return `${category}::${index}::${item}`;
  }

  // Initialize checkboxes from storage
  function initializeCheckboxes(): void {
    const checked = loadCheckedItems();
    // Only initialize local checkboxes (not globally checked ones)
    const checkboxes = document.querySelectorAll<HTMLInputElement>('.grocery-checkbox.local-checkbox');
    
    checkboxes.forEach((checkbox) => {
      const itemKey = getItemKey(checkbox);
      if (checked.has(itemKey)) {
        checkbox.checked = true;
        // Add locally-checked class to parent for styling
        checkbox.closest('.grocery-item')?.classList.add('locally-checked');
      }
      
      // Add change listener for local checkboxes only
      checkbox.addEventListener('change', () => {
        const currentChecked = loadCheckedItems();
        const parentItem = checkbox.closest('.grocery-item');
        if (checkbox.checked) {
          currentChecked.add(itemKey);
          parentItem?.classList.add('locally-checked');
        } else {
          currentChecked.delete(itemKey);
          parentItem?.classList.remove('locally-checked');
        }
        saveCheckedItems(currentChecked);
      });
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeCheckboxes);
  } else {
    initializeCheckboxes();
  }
</script>

<style>
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
  }

  .grocery-categories {
    display: grid;
    gap: var(--spacing-lg);
  }

  .grocery-category {
    background: var(--color-bg-alt);
    padding: var(--spacing-md);
    border-radius: 6px;
  }

  .grocery-category h3 {
    margin-top: 0;
    margin-bottom: var(--spacing-md);
    color: var(--color-primary);
  font-size: 1.4rem;
  }

  .grocery-items {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .grocery-item {
    display: flex;
    align-items: center;
  }

  .grocery-item label {
    display: flex;
    align-items: center;
    cursor: pointer;
    width: 100%;
    padding: calc(var(--spacing-xs) + 2px);
    border-radius: 4px;
    transition: background-color 0.2s ease;
  font-size: 1.1rem;
  line-height: 1.68;
  }

  .grocery-item label:hover {
    background-color: rgba(44, 95, 45, 0.05);
  }

  .item-text {
    flex: 1;
  }

  /* Local checkbox - checked with strikethrough (shopper behavior) */
  .grocery-item.locally-checked .item-text {
    text-decoration: line-through;
    color: var(--color-text-light);
  }

  /* Global checkbox - circle dot inside square, greyed out but NOT crossed out */
  .grocery-item.globally-checked .item-text {
    color: var(--color-text-muted, #9a9a91);
  }

  .grocery-item.globally-checked label {
    cursor: default;
  }

  .grocery-item.globally-checked label:hover {
    background-color: transparent;
  }

  /* Global checkbox visual style - circle with dot inside */
  .global-checkbox {
    position: relative;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background: var(--color-bg);
    border: 2px solid var(--color-text-muted, #9a9a91);
    cursor: default;
  }

  .global-checkbox::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    background: var(--color-text-muted, #9a9a91);
    border-radius: 50%;
  }

  /* Local checkbox styling */
  .local-checkbox:checked {
    background: var(--color-primary);
    border-color: var(--color-primary);
  }

  .local-checkbox:checked::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 0.75rem;
    font-weight: bold;
  }

  @media (max-width: 768px) {
    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--spacing-md);
    }
    
    .grocery-category {
      padding: var(--spacing-lg);
    }
    
    .grocery-category h3 {
    font-size: 1.75rem;
      margin-bottom: var(--spacing-md);
    }
    
    .grocery-item label {
      padding: var(--spacing-sm) var(--spacing-xs);
    font-size: 1.3rem;
    }
    
    .item-text {
    font-size: 1.3rem;
    line-height: 1.75;
    }
  }
</style>

