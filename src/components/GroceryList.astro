---
import type { ListCategory } from '../utils/weekParser';

interface Props {
  categories: ListCategory[];
}

const { categories } = Astro.props;
---

<div id="print-section-grocery-list" class="print-section bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg p-lg mb-xl w-full" data-section-type="grocery">
  <div class="flex justify-between items-center mb-lg">
    <h2>Grocery List</h2>
  </div>
  
  <div class="grid gap-lg">
    {categories.map((category) => (
      <div class="grocery-category bg-[var(--color-bg-alt)] p-md rounded-md mobile:p-lg">
        <h3 class="mt-0 mb-md text-[var(--color-primary)] text-[1.4rem] mobile:text-[1.75rem] mobile:mb-md">{category.name}</h3>
        <ul class="grocery-items flex flex-col gap-sm">
          {category.items.map((item, index) => (
            <li class={`flex items-center grocery-item ${item.globallyChecked ? 'globally-checked' : ''}`}>
              <label class="flex items-center cursor-pointer w-full p-[calc(var(--spacing-xs)+2px)] rounded transition-colors hover:bg-[rgba(44,95,45,0.05)] text-[1.1rem] leading-relaxed mobile:p-sm mobile:text-[1.3rem]">
                <input
                  type="checkbox"
                  class={`grocery-checkbox ${item.globallyChecked ? 'global-checkbox' : 'local-checkbox'}`}
                  data-category={category.name}
                  data-index={index}
                  data-item={item.text}
                  data-globally-checked={item.globallyChecked ? 'true' : 'false'}
                  checked={item.globallyChecked}
                  disabled={item.globallyChecked}
                />
                <span class="flex-1 item-text mobile:text-[1.3rem] mobile:leading-extra-loose">{item.text}</span>
              </label>
            </li>
          ))}
        </ul>
      </div>
    ))}
  </div>
</div>

<script>
  // Store checked items in localStorage with week-specific key
  function getStorageKey(): string {
    // Get week title from page to create unique key
    const weekElement = document.querySelector('h1');
    const weekTitle = weekElement?.textContent || 'current-week';
    return `grocery-list-${weekTitle.toLowerCase().replace(/\s+/g, '-')}`;
  }

  function loadCheckedItems(): Set<string> {
    const key = getStorageKey();
    const stored = localStorage.getItem(key);
    return stored ? new Set(JSON.parse(stored)) : new Set();
  }

  function saveCheckedItems(checked: Set<string>): void {
    const key = getStorageKey();
    localStorage.setItem(key, JSON.stringify([...checked]));
  }

  function getItemKey(checkbox: HTMLInputElement): string {
    const category = checkbox.dataset.category || '';
    const index = checkbox.dataset.index || '';
    const item = checkbox.dataset.item || '';
    return `${category}::${index}::${item}`;
  }

  // Initialize checkboxes from storage
  function initializeCheckboxes(): void {
    const checked = loadCheckedItems();
    // Only initialize local checkboxes (not globally checked ones)
    const checkboxes = document.querySelectorAll<HTMLInputElement>('.grocery-checkbox.local-checkbox');
    
    checkboxes.forEach((checkbox) => {
      const itemKey = getItemKey(checkbox);
      if (checked.has(itemKey)) {
        checkbox.checked = true;
        // Add locally-checked class to parent for styling
        checkbox.closest('.grocery-item')?.classList.add('locally-checked');
      }
      
      // Add change listener for local checkboxes only
      checkbox.addEventListener('change', () => {
        const currentChecked = loadCheckedItems();
        const parentItem = checkbox.closest('.grocery-item');
        if (checkbox.checked) {
          currentChecked.add(itemKey);
          parentItem?.classList.add('locally-checked');
        } else {
          currentChecked.delete(itemKey);
          parentItem?.classList.remove('locally-checked');
        }
        saveCheckedItems(currentChecked);
      });
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeCheckboxes);
  } else {
    initializeCheckboxes();
  }
</script>

<style>
  /* Semantic state classes - keep for functionality */
  .grocery-item.locally-checked .item-text {
    text-decoration: line-through;
    color: var(--color-text-light);
  }

  .grocery-item.globally-checked .item-text {
    color: var(--color-text-muted, #9a9a91);
  }

  .grocery-item.globally-checked label {
    cursor: default;
  }

  .grocery-item.globally-checked label:hover {
    background-color: transparent !important;
  }

  /* Custom checkbox styling - needs to stay as CSS (complex pseudo-elements) */
  .global-checkbox {
    position: relative;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background: var(--color-bg);
    border: 2px solid var(--color-text-muted, #9a9a91);
    cursor: default;
  }

  .global-checkbox::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    background: var(--color-text-muted, #9a9a91);
    border-radius: 50%;
  }

  .local-checkbox {
    position: relative;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background: var(--color-bg);
    border: 2px solid var(--color-border);
    cursor: pointer;
  }

  .local-checkbox:checked {
    background: var(--color-primary);
    border-color: var(--color-primary);
  }

  .local-checkbox:checked::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 0.85rem;
    font-weight: 600;
    line-height: 1;
  }
</style>

