--- 
interface MealNavItem {
  id: string;
  title: string;
  cooked: boolean;
}

interface Props {
  shortTitle: string;
  meals: MealNavItem[];
  hasGroceryList: boolean;
}

const { shortTitle, meals, hasGroceryList } = Astro.props;
---

<header class="sticky-header" id="sticky-header" data-scrolled="false">
  <!-- Chef hat icon - visible when at top, centered decorative element -->
  <div class="header-chef-hat">
    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M19 19.002v1.998a1 1 0 0 1 -.883 .993l-.117 .007h-12a1 1 0 0 1 -1 -1v-1.994a1 1 0 0 1 1 -1l12 -.004a1 1 0 0 1 1 1"></path>
      <path d="M12 2a5 5 0 0 1 4.533 2.888l.06 .137l.136 -.009a5 5 0 0 1 4.99 3.477l.063 .213a5 5 0 0 1 -2.696 5.831l-.087 .037v1.428a1 1 0 0 1 -1 1l-12 .004a1 1 0 0 1 -.993 -.883l-.007 -.117v-1.433l-.123 -.055a5 5 0 0 1 -2.6 -3.001l-.064 -.223a5 5 0 0 1 5.193 -6.27l.066 -.142a5 5 0 0 1 4.302 -2.877z"></path>
    </svg>
  </div>

  <!-- Scrolled nav - visible when scrolled down -->
  <nav class="header-nav">
    <!-- Nav buttons cluster (left side) -->
    <div class="nav-buttons">
      <a href="#top" class="nav-btn date-btn">{shortTitle}</a>
      
      {hasGroceryList && (
        <a href="#print-section-grocery-list" class="nav-btn" data-section="grocery-list">
          Grocery
        </a>
      )}
      
      {meals.map((meal) => (
        <a 
          href={`#print-section-${meal.id}`} 
          class={`nav-btn ${meal.cooked ? 'cooked' : ''}`}
          data-section={meal.id}
        >
          {meal.cooked ? '✓ ' : ''}{meal.title}
        </a>
      ))}
    </div>
    
    <!-- Mobile: Date button (separate from desktop, appears on scroll) -->
    <a href="#top" class="mobile-date-btn">{shortTitle}</a>
  
    <!-- Mobile: Section selector with dropdown -->
    <div class="section-selector">
      <button class="section-selector-btn" aria-expanded="false" aria-haspopup="true">
        <svg class="dropdown-caret" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
        <span class="current-section-name">Full Week</span>
      </button>
  
      <div class="section-dropdown" hidden>
        <a href="#top" class="dropdown-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="19" x2="12" y2="5"></line>
            <polyline points="5 12 12 5 19 12"></polyline>
          </svg>
          Back to Top
        </a>
        
        {hasGroceryList && (
          <a href="#print-section-grocery-list" class="dropdown-link" data-section="grocery-list">
            Grocery List
          </a>
        )}
        
        {meals.map((meal) => (
          <a 
            href={`#print-section-${meal.id}`} 
            class={`dropdown-link ${meal.cooked ? 'cooked' : ''}`}
            data-section={meal.id}
          >
            {meal.cooked ? '✓ ' : ''}{meal.title}
          </a>
        ))}
        
        <a href="#site-footer" class="dropdown-link" data-section="footer">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          Links & Info
        </a>
      </div>
    </div>
    
    <!-- Right side: Info icon button + Print button -->
    <div class="header-right-buttons">
      <!-- Info icon button - links to footer -->
      <a href="#site-footer" class="header-info-btn" data-section="footer" aria-label="Links & Info">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
      </a>
      
      <!-- Print Button -->
      <button class="header-print-btn print-button" data-print-target="all" type="button">
        <svg class="print-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 6 2 18 2 18 9"></polyline>
          <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
          <rect x="6" y="14" width="12" height="8"></rect>
        </svg>
        <span class="print-section-name">Grocery List</span>
      </button>
    </div>
  </nav>
</header>

<div class="header-spacer"></div>

<style>
  .sticky-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: var(--color-bg);
    border-bottom: 1px solid transparent;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }

  /* Shadow appears immediately on any scroll */
  .sticky-header[data-has-shadow="true"] {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  /* When scrolled, show border */
  .sticky-header[data-scrolled="true"] {
    border-bottom-color: var(--color-border);
  }

  .header-spacer {
    height: 56px;
  }

  /* ============================================
     CHEF HAT - Decorative icon at top
     ============================================ */
  .header-chef-hat {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 56px;
    color: var(--color-text);
    opacity: 1;
    transition: opacity 0.3s ease;
  }

  /* Fade out chef hat when scrolled */
  .sticky-header[data-scrolled="true"] .header-chef-hat {
    opacity: 0;
    pointer-events: none;
  }

  /* ============================================
     NAV - Hidden at top, visible when scrolled
     ============================================ */
  .header-nav {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    padding: 0 var(--spacing-md);
    max-width: 1200px;
    margin: 0 auto;
    height: 56px;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  /* Fade in nav when scrolled */
  .sticky-header[data-scrolled="true"] .header-nav {
    opacity: 1;
    pointer-events: auto;
  }

  /* ============================================
     NAV BUTTONS CONTAINER
     ============================================ */
  .nav-buttons {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
  }

  /* ============================================
     NAV BUTTONS - All buttons share base style
     ============================================ */
  .nav-btn {
    padding: 8px 12px;
    height: 36px;
    border-radius: 4px;
    text-decoration: none;
    color: var(--color-text);
    font-size: 0.9rem;
    font-weight: 500;
    line-height: 1;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .nav-btn:hover {
    background: var(--color-bg-alt);
  }

  .nav-btn.active {
    background: var(--color-bg-alt);
    color: var(--color-primary);
    font-weight: 600;
  }

  .nav-btn.cooked {
    color: var(--color-cooked-text);
    opacity: 0.7;
  }

  .nav-btn.cooked.active {
    background: var(--color-cooked-bg);
  }

  /* ============================================
     DATE BUTTON
     ============================================ */
  .date-btn {
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--color-primary);
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* ============================================
     MOBILE DATE BUTTON
     ============================================ */
  .mobile-date-btn {
    display: none;
    position: absolute;
    left: var(--spacing-md);
    padding: 8px 12px;
    height: 36px;
    border-radius: 4px;
    text-decoration: none;
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 1rem;
    color: var(--color-primary);
    line-height: 1;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease;
  }

  .mobile-date-btn:hover {
    background: var(--color-bg-alt);
  }

  /* ============================================
     SECTION SELECTOR (Mobile dropdown)
     ============================================ */
  .section-selector {
    display: none;
    position: relative;
  }

  .section-selector-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 8px 12px;
    height: 36px;
    background: transparent;
    border: none;
    border-radius: 4px;
    font-family: inherit;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-primary);
    cursor: pointer;
    transition: background-color 0.2s ease;
    line-height: 1;
  }

  .section-selector-btn:hover {
    background: var(--color-bg-alt);
  }

  .dropdown-caret {
    flex-shrink: 0;
    transition: transform 0.2s ease;
  }

  .section-selector-btn[aria-expanded="true"] .dropdown-caret {
    transform: rotate(180deg);
  }

  .current-section-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px;
  }

  .section-dropdown {
    position: absolute;
    top: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%);
    min-width: 280px;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    z-index: 10;
  }

  .section-dropdown[hidden] {
    display: none;
  }

  .dropdown-link {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: 14px 18px;
    text-decoration: none;
    color: var(--color-text);
    font-size: 1.1rem;
    border-radius: 8px;
    transition: background-color 0.2s ease;
  }

  .dropdown-link:hover {
    background: var(--color-bg-alt);
  }

  .dropdown-link.active {
    background: var(--color-bg-alt);
    font-weight: 600;
    color: var(--color-primary);
  }

  .dropdown-link.cooked {
    color: var(--color-cooked-text);
  }

  .dropdown-link svg {
    flex-shrink: 0;
    opacity: 0.6;
  }

  /* ============================================
     RIGHT BUTTONS CONTAINER (Info + Print)
     ============================================ */
  .header-right-buttons {
    position: absolute;
    right: var(--spacing-md);
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
  }

  /* ============================================
     INFO ICON BUTTON
     ============================================ */
  .header-info-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 4px;
    color: var(--color-text);
    text-decoration: none;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .header-info-btn:hover {
    background: var(--color-bg-alt);
  }

  .header-info-btn.active {
    background: var(--color-bg-alt);
    color: var(--color-primary);
  }

  /* ============================================
     PRINT BUTTON
     ============================================ */
  .header-print-btn {
    padding: 8px 14px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    border: none;
    background: var(--color-secondary);
    color: var(--color-text);
    font-family: inherit;
    line-height: 1;
    cursor: pointer;
    height: 36px;
    min-width: 36px;
  }

  .header-print-btn:hover {
    background: var(--color-secondary-hover);
  }

  .header-print-btn .print-icon {
    flex-shrink: 0;
  }

  .header-print-btn .print-section-name {
    display: inline;
  }

  /* ============================================
     TABLET - 1000px
     ============================================ */
  @media screen(desktop) {
    .header-print-btn .print-section-name {
      display: none;
    }

    .nav-btn {
      font-size: 0.85rem;
      padding: 8px 10px;
    }

    .date-btn {
      font-size: 1rem;
    }
  }

  /* ============================================
     MOBILE - 950px
     ============================================ */
  @media screen(tablet) {
    /* Mobile nav is centered */
    .sticky-header[data-scrolled="true"] .header-nav {
      justify-content: center;
    }

    .nav-buttons {
      display: none;
    }

    .section-selector {
      display: block;
    }

    .mobile-date-btn {
      display: inline-flex;
    }

    .header-print-btn {
      padding: 8px 20px;
      min-width: 52px;
    }

    .header-print-btn .print-section-name {
      display: none;
    }
  }

  /* ============================================
     SMALL MOBILE - 500px
     ============================================ */
  @media screen(sm-mobile) {
    .header-print-btn {
      padding: 8px 16px;
      min-width: 48px;
    }

    .current-section-name {
      max-width: 140px;
    }

    .section-selector-btn {
      padding: 8px 10px;
    }
  }
</style>

<script>
  import { printSection } from '../utils/printGenerator';

  const scrollThresholds = {
    HEADER_ACTIVATION: 100,
    SECTION_VISIBILITY: 0.25,
    FADE_OUT_START: 0.85,
  } as const;

  // ============================================
  // HEADER STATE MANAGEMENT
  // ============================================

  const header = document.getElementById('sticky-header') as HTMLElement;
  const sectionSelectorBtn = document.querySelector('.section-selector-btn') as HTMLButtonElement;
  const sectionDropdown = document.querySelector('.section-dropdown') as HTMLElement;
  const currentSectionName = document.querySelector('.current-section-name') as HTMLElement;
  const headerPrintBtn = document.querySelector('.header-print-btn') as HTMLButtonElement;
  const headerInfoBtn = document.querySelector('.header-info-btn') as HTMLAnchorElement;
  const navBtns = document.querySelectorAll('.nav-btn[data-section], .dropdown-link[data-section]') as NodeListOf<HTMLAnchorElement>;

  const SCROLL_THRESHOLD = scrollThresholds.HEADER_ACTIVATION;
  const FADE_OUT_START = scrollThresholds.FADE_OUT_START;
  
  let isScrolled = false;
  let hasShadow = false;
  let currentSection = 'all';
  let isFadingIn = false;

  function updateScrollState(): void {
    const scrollY = window.scrollY;
    const scrolled = scrollY > SCROLL_THRESHOLD;
    const shouldHaveShadow = scrollY > 0;
    
    // Shadow appears immediately on any scroll
    if (shouldHaveShadow !== hasShadow) {
      hasShadow = shouldHaveShadow;
      header.dataset.hasShadow = shouldHaveShadow ? 'true' : 'false';
    }
    
    // Nav appears at threshold
    if (scrolled !== isScrolled) {
      isScrolled = scrolled;
      header.dataset.scrolled = scrolled ? 'true' : 'false';
    }
    
    if (scrolled) {
      updateActiveSection();
    }
  }

  function buildSectionData(scrollY: number): { id: string; top: number; bottom: number; height: number; }[] {
    const sections: { id: string; top: number; bottom: number; height: number; }[] = [];
    document.querySelectorAll('.print-section').forEach(el => {
      const rect = el.getBoundingClientRect();
      sections.push({
        id: el.id.replace('print-section-', ''),
        top: rect.top + scrollY,
        bottom: rect.bottom + scrollY,
        height: rect.height
      });
    });
    return sections;
  }

  function checkFooterSection(viewportMidpoint: number, scrollY: number, viewportHeight: number): { id: string; top: number; bottom: number; height: number; } | null {
    const footer = document.getElementById('site-footer');
    if (!footer) return null;

    const footerRect = footer.getBoundingClientRect();
    const footerTop = footerRect.top + scrollY;
    const footerBottom = footerRect.bottom + scrollY;
    
    if (viewportMidpoint >= footerTop && viewportMidpoint < footerBottom) {
      return { id: 'footer', top: footerTop, bottom: footerBottom, height: footerRect.height };
    }

    const viewportBottom = scrollY + viewportHeight;
    if (viewportBottom >= footerTop + 100) {
      return { id: 'footer', top: footerTop, bottom: footerBottom, height: footerRect.height };
    }

    const maxScroll = document.documentElement.scrollHeight - viewportHeight;
    if (scrollY >= maxScroll - 10) {
      return { id: 'footer', top: footerTop, bottom: footerBottom, height: footerRect.height };
    }

    return null;
  }

  function handleSectionFadeOut(foundSectionData: { top: number; height: number; }, viewportMidpoint: number): void {
    if (!headerPrintBtn || isFadingIn) return;

    const positionInSection = viewportMidpoint - foundSectionData.top;
    const sectionProgress = positionInSection / foundSectionData.height;

    if (sectionProgress > FADE_OUT_START) {
      const fadeProgress = (sectionProgress - FADE_OUT_START) / (1 - FADE_OUT_START);
      const opacity = Math.max(0, 1 - fadeProgress);
      headerPrintBtn.style.transition = 'none';
      headerPrintBtn.style.opacity = opacity.toString();
    } else {
      headerPrintBtn.style.transition = 'none';
      headerPrintBtn.style.opacity = '1';
    }
  }

  function updateActiveSection(): void {
    const scrollY = window.scrollY;
    const viewportHeight = window.innerHeight;
    const viewportMidpoint = scrollY + (viewportHeight * 0.5);

    const sections = buildSectionData(scrollY);
    const footerData = checkFooterSection(viewportMidpoint, scrollY, viewportHeight);
    
    let foundSection: string | null = null;
    let foundSectionData: { id: string; top: number; bottom: number; height: number; } | null = null;
    
    if (footerData) {
      foundSection = footerData.id;
      foundSectionData = footerData;
    } else {
      for (const section of sections) {
        if (viewportMidpoint >= section.top && viewportMidpoint < section.bottom) {
          foundSection = section.id;
          foundSectionData = section;
          break;
        }
      }
    }
    
    if (foundSection === null) return;

    if (foundSection !== currentSection) {
      currentSection = foundSection;
      updateNavHighlight(foundSection);
      updateMobileSelector(foundSection);
      fadeInPrintButton(foundSection);
      return;
    }
    
    if (foundSectionData) {
      handleSectionFadeOut(foundSectionData, viewportMidpoint);
    }
  }

  function fadeInPrintButton(sectionId: string): void {
    if (!headerPrintBtn) return;
    
    isFadingIn = true;
    
    headerPrintBtn.style.transition = 'none';
    headerPrintBtn.style.opacity = '0';
    updatePrintButton(sectionId);
    
    headerPrintBtn.offsetHeight;
    headerPrintBtn.style.transition = 'opacity 0.2s ease-out';
    headerPrintBtn.style.opacity = '1';
    
    setTimeout(() => { isFadingIn = false; }, 200);
  }

  function updateNavHighlight(activeSection: string): void {
    navBtns.forEach(link => {
      const linkSection = link.getAttribute('data-section');
      link.classList.toggle('active', linkSection === activeSection);
    });
    
    if (headerInfoBtn) {
      headerInfoBtn.classList.toggle('active', activeSection === 'footer');
    }
  }

  function updatePrintButton(sectionId: string): void {
    if (!headerPrintBtn) return;
    
    const printTarget = sectionId === 'footer' ? 'all' : sectionId;
    const displayName = getDisplayName(printTarget);
    
    headerPrintBtn.dataset.printTarget = printTarget;
    
    const sectionNameEl = headerPrintBtn.querySelector('.print-section-name');
    if (sectionNameEl) {
      sectionNameEl.textContent = displayName;
    }
  }

  function updateMobileSelector(sectionId: string): void {
    if (currentSectionName) {
      currentSectionName.textContent = getDisplayName(sectionId);
    }
  }

  function getDisplayName(sectionId: string): string {
    if (sectionId === 'all') return 'Full Week';
    if (sectionId === 'grocery-list') return 'Grocery List';
    if (sectionId === 'footer') return 'Links & Info';
    if (sectionId.startsWith('meal-')) {
      const mealLink = document.querySelector(`.nav-btn[data-section="${sectionId}"]`);
      if (mealLink) {
        const raw = mealLink.textContent?.trim() || 'Meal';
        return raw.replace(/^[✓\u2713]\s*/, '');
      }
    }
    return sectionId;
  }

  function closeSectionDropdown(): void {
    if (sectionSelectorBtn && sectionDropdown) {
      sectionSelectorBtn.setAttribute('aria-expanded', 'false');
      sectionDropdown.hidden = true;
    }
  }

  function setupSectionDropdown(): void {
    if (!sectionSelectorBtn || !sectionDropdown) return;

    sectionSelectorBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isExpanded = sectionSelectorBtn.getAttribute('aria-expanded') === 'true';
      sectionSelectorBtn.setAttribute('aria-expanded', (!isExpanded).toString());
      sectionDropdown.hidden = isExpanded;
    });

    sectionDropdown.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', closeSectionDropdown);
    });

    document.addEventListener('click', (e) => {
      if (!sectionSelectorBtn.contains(e.target as Node) && !sectionDropdown.contains(e.target as Node)) {
        closeSectionDropdown();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSectionDropdown();
    });
  }

  function setupSmoothScroll(): void {
    document.querySelectorAll('.nav-btn, .dropdown-link, .mobile-date-btn, .hero-summary-link, .header-info-btn, .hero-action-btn, .footer-link').forEach(link => {
      link.addEventListener('click', (e) => {
        const href = (link as HTMLAnchorElement).getAttribute('href');
        if (href?.startsWith('#')) {
          e.preventDefault();
          
          if (href === '#top') {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return;
          }
          
          const target = document.querySelector(href);
          if (target) {
            const headerHeight = header.offsetHeight;
            const targetPosition = target.getBoundingClientRect().top + window.scrollY - headerHeight - 20;
            window.scrollTo({ top: targetPosition, behavior: 'smooth' });
          }
        }
      });
    });
  }

  function setupPrintButtons(): void {
    if (headerPrintBtn) {
      headerPrintBtn.addEventListener('click', () => {
        closeSectionDropdown();
        const target = headerPrintBtn.dataset.printTarget || 'all';
        printSection(target);
      });
    }
    
    const heroPrintBtn = document.getElementById('hero-print-full-week');
    if (heroPrintBtn) {
      heroPrintBtn.addEventListener('click', () => {
        printSection('all');
      });
    }
  }

  function init(): void {
    header.dataset.scrolled = 'false';
    header.dataset.hasShadow = 'false';
    updateScrollState();
    setupSectionDropdown();
    setupSmoothScroll();
    setupPrintButtons();

    window.addEventListener('scroll', updateScrollState, { passive: true });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
