---
import GroceryList from './GroceryList.astro';
import MealCard from './MealCard.astro';
import Footer from './Footer.astro';
import StickyHeader from './StickyHeader.astro';
import { getInstructionColor } from '../config/colors';
import type { WeekPlan } from '../utils/weekParser';

interface Props {
  weekPlan: WeekPlan;
}

const { weekPlan } = Astro.props;

// Derive short title: "Week of December 7-13, 2025" → "Dec 7-13"
// Also handle "Weekend of ..." format
const shortTitle = weekPlan.weekTitle
  .replace(/Week of /, '')
  .replace(/Weekend of /, '')
  .replace(/(\w+)\s+(\d+-\d+),\s+\d+/, (_, month, days) => 
    `${month.slice(0, 3)} ${days}`
  );

// Prepare meals for header navigation
const mealsForNav = weekPlan.meals.map(meal => ({
  id: meal.id,
  title: meal.title,
  cooked: meal.cooked
}));

// Build favicon path
const baseUrl = import.meta.env.BASE_URL.endsWith('/') 
  ? import.meta.env.BASE_URL 
  : import.meta.env.BASE_URL + '/';
const faviconSrc = baseUrl + 'favicon.svg';
---

<StickyHeader 
  shortTitle={shortTitle}
  meals={mealsForNav}
  hasGroceryList={weekPlan.groceryList.length > 0}
/>

<div class="max-w-container w-full mx-auto overflow-x-hidden px-md pt-0 pb-lg mobile:px-sm">
  <!-- Hero Section -->
  <section class="text-center px-md py-xl min-h-[40vh] flex flex-col items-center justify-center gap-lg mobile:min-h-[30vh] mobile:px-sm" id="top">
    <h1 class="mb-0">{weekPlan.weekTitle}</h1>
    <div class="flex justify-center">
      <img src={faviconSrc} alt="Food of the Week" class="w-20 h-20 opacity-60" />
    </div>

    {/* Hero Summary */}
    {weekPlan.heroSummary.length > 0 && (
      <div class="hero-summary flex flex-col gap-md items-center mt-lg">
        {weekPlan.heroSummary.map((summaryLine) => {
          // Parse: "Meal Name • Codename • Details"
          const parts = summaryLine.split(' • ');
          if (parts.length < 2) return null;

          const mealName = parts[0];
          const codename = parts[1];
          const details = parts[2] || '';

          // Get first palette color for codename
          const paletteScheme = getInstructionColor(0); // First cycling color

          return (
            <div class="hero-summary-item flex items-center gap-sm px-md py-sm rounded-md bg-bg border border-border hover:bg-bg-alt transition-colors">
              {/* Meal Name - styled like header buttons */}
              <span class="meal-name px-sm py-xs rounded font-medium text-primary hover:bg-bg-alt cursor-pointer transition-colors">
                {mealName}
              </span>

              {/* Codename - styled with first palette color */}
              <span
                class="codename px-sm py-xs rounded font-medium"
                style={`background: ${paletteScheme.bg}; color: ${paletteScheme.heading}; border: 1px solid ${paletteScheme.border}`}
              >
                {codename}
              </span>

              {/* Details - styled like info subsection with gold underline */}
              {details && (
                <span
                  class="details px-sm py-xs rounded font-medium bg-bg-alt border-b-2 border-secondary"
                  style="border-bottom-color: var(--color-secondary);"
                >
                  {details}
                </span>
              )}
            </div>
          );
        })}
      </div>
    )}
  </section>
  
  {weekPlan.groceryList.length > 0 && (
    <GroceryList 
      categories={weekPlan.groceryList}
    />
  )}
  
  <div class="flex flex-col gap-xl mobile:gap-lg">
    {weekPlan.meals.map((section) => (
      <MealCard section={section} />
    ))}
  </div>
  
  {weekPlan.meals.length === 0 && weekPlan.groceryList.length === 0 && (
    <div class="text-center p-xl bg-bg-alt border border-border rounded-lg mb-xl">
      <h2 class="mt-0 text-text-light">No meal plan available</h2>
      <p class="text-text-light mb-0">Check back later for this week's meal plan, or add content to FOOD-OF-THE-WEEK.md to get started.</p>
    </div>
  )}

  <Footer />
</div>

<style>
  /* All layout/spacing now handled by Tailwind utilities */
  /* Kept only for semantic class names used by other components */
</style>

