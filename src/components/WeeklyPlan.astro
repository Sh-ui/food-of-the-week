---
import GroceryList from './GroceryList.astro';
import MealCard from './MealCard.astro';
import Footer from './Footer.astro';
import StickyHeader from './StickyHeader.astro';
import { getInstructionBadgeColor, sectionColors } from '../config/colors';
import type { WeekPlan } from '../utils/weekParser';

interface Props {
  weekPlan: WeekPlan;
}

const { weekPlan } = Astro.props;

interface HeroRow {
  id: string;
  mealName: string;
  codename: string;
  details: string;
  cooked: boolean;
  colorIndex: number;
}

// Derive short title: "Week of December 7-13, 2025" → "Dec 7-13"
// Also handle "Weekend of ..." format
const shortTitle = weekPlan.weekTitle
  .replace(/Week of /, '')
  .replace(/Weekend of /, '')
  .replace(/(\w+)\s+(\d+-\d+),\s+\d+/, (_, month, days) => 
    `${month.slice(0, 3)} ${days}`
  );

// Prepare meals for header navigation
const mealsForNav = weekPlan.meals.map(meal => ({
  id: meal.id,
  title: meal.title,
  cooked: meal.cooked
}));

const heroRowsFromMeals: HeroRow[] = weekPlan.meals
  .map((meal, idx) => {
    if (!meal.quickRead?.codename) return null;
    return {
      id: meal.id,
      mealName: meal.title,
      codename: meal.quickRead.codename,
      details: meal.quickRead.details ?? '',
      cooked: meal.cooked,
      colorIndex: idx,
    };
  })
  .filter((row): row is HeroRow => row !== null);

const mealLookup = new Map(
  weekPlan.meals.map((meal, idx) => [meal.title.trim().toLowerCase(), { id: meal.id, cooked: meal.cooked, colorIndex: idx }])
);

const heroRowsFromLegacy: HeroRow[] = weekPlan.heroSummary
  .map((summaryLine, idx) => {
    const parts = summaryLine.split(/\s*•\s*/).map(p => p.trim()).filter(Boolean);
    if (parts.length < 2) return null;
    const match = mealLookup.get(parts[0].trim().toLowerCase());
    return {
      id: match?.id ?? '',
      mealName: parts[0],
      codename: parts[1],
      details: parts[2] ?? '',
      cooked: match?.cooked ?? false,
      colorIndex: match?.colorIndex ?? idx,
    };
  })
  .filter((row): row is HeroRow => row !== null);

const heroRows = heroRowsFromMeals.length > 0 ? heroRowsFromMeals : heroRowsFromLegacy;

 
---

<StickyHeader 
  shortTitle={shortTitle}
  meals={mealsForNav}
  hasGroceryList={weekPlan.groceryList.length > 0}
/>

<div class="max-w-container w-full mx-auto overflow-x-hidden px-md pt-0 pb-lg mobile:px-sm">
  <!-- Hero Section -->
  <section class="text-center px-md py-xl min-h-[40vh] flex flex-col items-center justify-center gap-lg mobile:min-h-[30vh] mobile:px-sm" id="top">
    <h1 class="mb-0">{weekPlan.weekTitle}</h1>
    <div class="flex items-center justify-center gap-sm text-text-muted opacity-70">
      <span class="h-px w-16 bg-border"></span>
      <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M19 19.002v1.998a1 1 0 0 1 -.883 .993l-.117 .007h-12a1 1 0 0 1 -1 -1v-1.994a1 1 0 0 1 1 -1l12 -.004a1 1 0 0 1 1 1"></path>
        <path d="M12 2a5 5 0 0 1 4.533 2.888l.06 .137l.136 -.009a5 5 0 0 1 4.99 3.477l.063 .213a5 5 0 0 1 -2.696 5.831l-.087 .037v1.428a1 1 0 0 1 -1 1l-12 .004a1 1 0 0 1 -.993 -.883l-.007 -.117v-1.433l-.123 -.055a5 5 0 0 1 -2.6 -3.001l-.064 -.223a5 5 0 0 1 5.193 -6.27l.066 -.142a5 5 0 0 1 4.302 -2.877z"></path>
      </svg>
      <span class="h-px w-16 bg-border"></span>
    </div>

    {/* Hero Summary */}
    {heroRows.length > 0 && (
      <div class="hero-summary flex flex-col gap-sm items-center mt-lg w-full max-w-[900px] mobile:gap-xs mobile:mt-md mobile:items-stretch">
        {heroRows.map((row) => {
          const codenameScheme = getInstructionBadgeColor(row.colorIndex);
          const infoScheme = sectionColors.firstSubsection;

          return (
            <a
              href={row.id ? `#print-section-${row.id}` : undefined}
              class={`hero-summary-link hero-summary-item w-full flex flex-wrap items-center justify-center gap-sm px-sm py-xs rounded-md bg-bg border border-border hover:bg-bg-alt transition-colors no-underline text-[0.95rem] mobile:gap-xs mobile:px-sm mobile:py-xs ${row.cooked ? 'opacity-60' : ''}`}
            >
              <span class="meal-name px-sm py-xs rounded font-semibold text-primary bg-transparent">
                {row.cooked ? '✓ ' : ''}{row.mealName}
              </span>

              <span
                class="codename px-sm py-xs rounded font-bold border mobile:text-[1.05rem]"
                style={`background: ${codenameScheme.bg}; color: ${codenameScheme.heading}; border-color: ${codenameScheme.border}`}
              >
                {row.codename}
              </span>

              {row.details && (
                <span
                  class="details px-sm py-xs rounded font-medium border mobile:text-[1.05rem]"
                  style={`background: ${infoScheme.bg}; color: ${infoScheme.heading}; border-color: ${infoScheme.border}`}
                >
                  {row.details}
                </span>
              )}
            </a>
          );
        })}
      </div>
    )}
  </section>
  
  {weekPlan.groceryList.length > 0 && (
    <GroceryList 
      categories={weekPlan.groceryList}
    />
  )}
  
  <div class="flex flex-col gap-xl mobile:gap-lg">
    {weekPlan.meals.map((section) => (
      <MealCard section={section} />
    ))}
  </div>
  
  {weekPlan.meals.length === 0 && weekPlan.groceryList.length === 0 && (
    <div class="text-center p-xl bg-bg-alt border border-border rounded-lg mb-xl">
      <h2 class="mt-0 text-text-light">No meal plan available</h2>
      <p class="text-text-light mb-0">Check back later for this week's meal plan, or add content to FOOD-OF-THE-WEEK.md to get started.</p>
    </div>
  )}

  <Footer />
</div>

<style>
  /* All layout/spacing now handled by Tailwind utilities */
  /* Kept only for semantic class names used by other components */
</style>

